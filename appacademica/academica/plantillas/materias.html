<form id="frmMateria" data-accion="nuevo" data-idmateria="0">
    <div class="card text-bg-dark mb-3" style="min-width: 700px;">
        <div class="card-header">
            <div class="d-flex">
                Registro de Materias
                <div class="ms-auto">
                    <button type="button" data-form="materias" class="btn-close btn-close-white" aria-label="Close"></button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Código -->
            <div class="row p-1">
                <div class="col-3 col-md-2">CÓDIGO</div>
                <div class="col-9 col-md-4">
                    <input type="text" class="form-control" id="txtCodigoMateria" name="txtCodigoMateria" required>
                </div>
            </div>
            <!-- Nombre -->
            <div class="row p-1">
                <div class="col-3 col-md-2">NOMBRE</div>
                <div class="col-9 col-md-6">
                    <input type="text" class="form-control" id="txtNombreMateria" name="txtNombreMateria" required>
                </div>
            </div>
            <!-- UV -->
            <div class="row p-1">
                <div class="col-3 col-md-2">UV</div>
                <div class="col-9 col-md-10">
                    <input type="text" class="form-control" id="txtUvMateria" name="txtUvMateria" required>
                </div>
            </div>
            <div class="row p-1">
                <div class="col-12 col-md-4 text-center d-grid gap-2">
                    <button type="submit" class="btn btn-outline-primary">Guardar</button>
                </div>
                <div class="col-12 col-md-4 text-center d-grid gap-2">
                    <button type="reset" class="btn btn-outline-warning">Nuevo</button>
                </div>
                <div class="col-12 col-md-4 text-center d-grid gap-2">
                    <button type="button" class="btn btn-outline-success" onclick="abrirVentana('busqueda_materias')">BUSCAR</button>
                </div>
            </div>
        </div>
    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
<script>
    const frmMateria = document.getElementById('frmMateria');
    const txtCodigoMateria = document.getElementById('txtCodigoMateria');
    const txtNombreMateria = document.getElementById('txtNombreMateria');
    const txtUvMateria = document.getElementById('txtUvMateria');

    // Validación de código: solo letras y números
    txtCodigoMateria.addEventListener('input', () => {
        const valor = txtCodigoMateria.value;
        const valorFiltrado = valor.replace(/[^A-Za-z0-9]/g, '');
        if (valor !== valorFiltrado) {
            alertify.error('El código solo permite letras y números');
            txtCodigoMateria.value = valorFiltrado; // Actualiza el valor del campo sin caracteres inválidos
        }
    });

    // Validación de nombre: solo letras y caracteres especiales
    txtNombreMateria.addEventListener('input', () => {
        const valor = txtNombreMateria.value;
        const valorFiltrado = valor.replace(/[^A-Za-zÁÉÍÓÚáéíóúÜüÑñ\s]/g, '');
        if (valor !== valorFiltrado) {
            alertify.error('El nombre solo puede contener letras y caracteres especiales');
            txtNombreMateria.value = valorFiltrado; // Actualiza el valor del campo
        }
    });

    // Validación de UV: solo números enteros
    txtUvMateria.addEventListener('input', () => {
        const valor = txtUvMateria.value;
        const valorFiltrado = valor.replace(/[^0-9]/g, '');
        if (valor !== valorFiltrado) {
            alertify.error('La UV debe ser un número entero positivo');
            txtUvMateria.value = valorFiltrado; // Actualiza el valor del campo
        }
    });

    // Validación y envío del formulario de materia
    frmMateria.addEventListener('submit', (e) => {
        e.preventDefault();

        // Validar que UV sea un número entero positivo
        if (txtUvMateria.value === '') {
            alertify.error("La UV es obligatoria y debe ser un número entero positivo");
            return;
        }

        let datos = {
            accion: frmMateria.dataset.accion,
            idMateria: frmMateria.dataset.idmateria,
            codigo: txtCodigoMateria.value,
            nombre: txtNombreMateria.value,
            uv: txtUvMateria.value
        };

        enviarDatosMateria(datos);
    });

    // Función para enviar datos a la API
    function enviarDatosMateria(datos) {
        fetch('guardar_materia/', {
            method: 'POST',
            body: JSON.stringify(datos),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Asegúrate de que este token se configure correctamente en tu plantilla
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.msg === 'ok') {
                alertify.success("Datos guardados correctamente");
                limpiarDatosMaterias();
            } else {
                alertify.error("Error al guardar los datos");
            }
        })
        .catch(err => {
            console.log(err);
        });
    }

    // Función para modificar materia
    function modificarMateria(materia) {
        frmMateria.dataset.accion = 'modificar';
        frmMateria.dataset.idmateria = materia.id;
        txtCodigoMateria.value = materia.codigo;
        txtNombreMateria.value = materia.nombre;
        txtUvMateria.value = materia.uv;
    }

    // Limpiar datos del formulario de materias
    function limpiarDatosMaterias() {
        frmMateria.dataset.accion = 'nuevo';
        frmMateria.dataset.idmateria = '';
        txtCodigoMateria.value = '';
        txtNombreMateria.value = '';
        txtUvMateria.value = '';
    }
</script>
